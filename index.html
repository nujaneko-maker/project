<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geometry Dash Clone - Pro Edition</title>
    <style>
        /* --- GLOBAL STYLES --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            flex-direction: column;
        }

        /* --- GAME CONTAINER & CANVAS --- */
        #gameContainer {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
            border: 2px solid #333;
            display: none; /* Ẩn ban đầu, chỉ hiển thị khi chơi */
        }

        canvas {
            display: block;
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            cursor: default;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            text-shadow: 1px 1px 0 #000;
        }

        /* --- MENU STYLES --- */
        .menu-screen {
            background: #111;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .menu-screen h2 {
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 30px;
        }
        
        .menu-screen button, .skin-option {
            width: 250px;
            padding: 15px;
            margin: 10px 0;
            background-color: #302b63;
            color: white;
            border: 2px solid #00ffff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
        }

        .menu-screen button:hover, .skin-option:hover {
            background-color: #4f4699;
            box-shadow: 0 0 15px #00ffff;
            transform: translateY(-2px);
        }
        
        /* --- SKIN SELECTOR --- */
        #skinMenu {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .skin-option {
            width: 100px;
            height: 100px;
            margin: 10px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 3px solid transparent;
            position: relative;
        }
        
        .skin-option.active {
            border-color: #ffc107;
            box-shadow: 0 0 20px #ffc107;
        }
        
        .skin-option::before {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 24px;
            color: #ffc107;
            opacity: 0;
        }
        
        .skin-option.active::before {
            opacity: 1;
        }
        
        /* Màu sắc Skins */
        .skin-blue { background-color: #00ffff30; border-color: #00ffff !important; }
        .skin-red { background-color: #ff000030; border-color: #ff0000 !important; }
        .skin-green { background-color: #00ff0030; border-color: #00ff00 !important; }

        /* --- EDITOR CONTROLS --- */
        .editor-controls {
            padding: 10px;
            background: #2a2a2a;
            color: white;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            width: 800px;
            box-sizing: border-box;
            display: none; /* Ẩn khi không ở Editor mode */
        }
        
        .control-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .editor-controls button {
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div id="mainMenu" class="menu-screen">
    <h2>NEON DASH - MENU CHÍNH</h2>
    <button onclick="showScreen('levelSelect')">Chọn Cấp Độ</button>
    <button onclick="showScreen('skinSelect')">Thay Đổi Skins</button>
    <button onclick="showScreen('editorScreen')">Level Editor</button>
</div>

<div id="levelSelect" class="menu-screen" style="display: none;">
    <h2>CHỌN CẤP ĐỘ (5 MAP)</h2>
    <button onclick="startGame(0)">Map 1: Khởi Đầu (Easy/Medium)</button>
    <button onclick="startGame(1)">Map 2: Focus WAVE (Medium/Hard)</button>
    <button onclick="startGame(2)">Map 3: Tốc Độ Cao (Hard)</button>
    <button onclick="startGame(3)">Map 4: Khối & Pads (Placeholder)</button>
    <button onclick="startGame(4)">Map 5: Chuyển Mode Liên Tục (Placeholder)</button>
    <button onclick="showScreen('mainMenu')">Quay lại Menu</button>
</div>

<div id="skinSelect" class="menu-screen" style="display: none;">
    <h2>CHỌN SKINS (Màu Sắc Player)</h2>
    <div id="skinMenu">
        </div>
    <button onclick="showScreen('mainMenu')">Quay lại Menu</button>
</div>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
        <h1 style="margin: 0; font-size: 24px;">NEON DASH</h1>
        <div id="score">Score: 0</div>
    </div>
</div>

<div id="editorControls" class="editor-controls">
    <div class="control-group">
        <button id="modeToggle">Chế độ: PLAY (P)</button>
        <button onclick="showScreen('mainMenu')">Menu Chính</button>
        <button id="saveMap">Lưu Map (S)</button>
        <button id="loadMap">Tải Map (L)</button>
    </div>
    
    <h3>Vật thể (Obstacles)</h3>
    <div id="toolSelector" class="control-group">
        <button class="tool-button active" data-type="SPIKE">Gai (1)</button>
        <button class="tool-button" data-type="BLOCK">Khối (2)</button>
        <button class="tool-button" data-type="PAD">Đệm Nhảy (3)</button>
    </div>
    
    <h3>Cổng Chuyển Đổi Độ Khó (Portals)</h3>
    <div id="portalSelector" class="control-group">
        <button class="tool-button portal-button" data-type="PORTAL_SPEED_NORMAL">Tốc độ Thường (4)</button>
        <button class="tool-button portal-button" data-type="PORTAL_SPEED_FAST">Tốc độ Nhanh (5)</button>
        <button class="tool-button mode-button" data-type="PORTAL_MODE_WAVE">Mode WAVE (6)</button>
        <button class="tool-button mode-button" data-type="PORTAL_MODE_CUBE">Mode CUBE (7)</button>
    </div>
</div>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geometry Dash Clone - Pro Edition</title>
    </head>
<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- CẤU HÌNH ---
    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 450;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;
    
    // --- THÔNG SỐ VẬT LÝ & LƯỚI ---
    const GRID_SIZE = 30; 
    const floorHeight = 50;
    const floorY = GAME_HEIGHT - floorHeight;
    const GRAVITY = 0.6;
    const JUMP_FORCE = -10.5;
    const WAVE_SPEED_Y = 6; 
    const SPEED_NORMAL = 6;
    const SPEED_FAST = 9;
    const VICTORY_SCORE = 500; // NEW: Ngưỡng điểm chiến thắng

    // --- BIẾN TOÀN CỤC ---
    let GAME_SPEED = 6; 
    let frame = 0;
    let score = 0;
    let currentMode = 'MENU'; 
    let playerMode = 'CUBE'; 
    let selectedTool = 'SPIKE'; 
    let currentMapIndex = 0; 

    // --- SKIN DATA ---
    const SKINS = [
        { name: 'Neon Blue', color: '#00ffff', class: 'skin-blue' },
        { name: 'Inferno Red', color: '#ff0000', class: 'skin-red' },
        { name: 'Electric Green', color: '#00ff00', class: 'skin-green' }
    ];
    let currentSkin = SKINS[0];

    // --- PLAYER ---
    const player = {
        x: 150, y: 300, w: 30, h: 30, dy: 0, 
        angle: 0, color: currentSkin.color, trail: [], cubeParticles: [],
        lastPortalPassed: null 
    };

    // --- LEVEL DATA (5 MAP) ---
    function getMapData(mapIndex) {
        if (mapIndex === 0) {
            // MAP 1: KHỞI ĐẦU
            return [
                { x: 600, y: 370, w: 30, h: 30, type: 'SPIKE' }, { x: 690, y: 370, w: 30, h: 30, type: 'SPIKE' }, { x: 780, y: 370, w: 30, h: 30, type: 'SPIKE' },
                { x: 900, y: 0, w: 30, h: 400, type: 'PORTAL_SPEED_FAST' }, 
                { x: 1080, y: 370, w: 30, h: 30, type: 'SPIKE' }, { x: 1140, y: 370, w: 30, h: 30, type: 'SPIKE' }, 
                { x: 1500, y: 370, w: 30, h: 30, type: 'BLOCK' }, { x: 1590, y: 340, w: 30, h: 30, type: 'BLOCK' }, { x: 1680, y: 370, w: 30, h: 30, type: 'BLOCK' },
                { x: 2100, y: 370, w: 30, h: 30, type: 'PAD' }, { x: 2130, y: 310, w: 30, h: 30, type: 'SPIKE' }, { x: 2280, y: 370, w: 30, h: 30, type: 'SPIKE' },
                { x: 2600, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_WAVE' }, { x: 2750, y: 370, w: 30, h: 30, type: 'BLOCK' }, { x: 2750, y: 0, w: 30, h: 400, type: 'BLOCK' },
                { x: 3300, y: 310, w: 30, h: 30, type: 'BLOCK' }, { x: 3300, y: 370, w: 30, h: 30, type: 'BLOCK' }, { x: 3450, y: 250, w: 30, h: 30, type: 'BLOCK' },
                { x: 3450, y: 370, w: 30, h: 30, type: 'BLOCK' }, { x: 3600, y: 310, w: 30, h: 30, type: 'BLOCK' }, { x: 3600, y: 370, w: 30, h: 30, type: 'BLOCK' },
                { x: 4000, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_CUBE' }, { x: 4000, y: 0, w: 30, h: 400, type: 'PORTAL_SPEED_NORMAL' }, 
                { x: 4100, y: 370, w: 30, h: 30, type: 'PAD' }, { x: 4130, y: 310, w: 30, h: 30, type: 'SPIKE' }, { x: 4200, y: 370, w: 30, h: 30, type: 'PAD' },
                { x: 4700, y: 0, w: 30, h: 400, type: 'PORTAL_SPEED_FAST' }, { x: 4700, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_WAVE' },
                { x: 4850, y: 340, w: 30, h: 30, type: 'BLOCK' }, { x: 4950, y: 280, w: 30, h: 30, type: 'BLOCK' }, { x: 5050, y: 340, w: 30, h: 30, type: 'BLOCK' },
                { x: 5600, y: 0, w: 30, h: 400, type: 'PORTAL_SPEED_NORMAL' }, { x: 5600, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_CUBE' },
                { x: 5750, y: 370, w: 30, h: 30, type: 'BLOCK' }, { x: 5780, y: 340, w: 30, h: 30, type: 'BLOCK' }, { x: 5840, y: 370, w: 30, h: 30, type: 'SPIKE' },
                { x: 5950, y: 310, w: 30, h: 30, type: 'BLOCK' }, 
                { x: 6500, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_WAVE' }, { x: 6600, y: 310, w: 30, h: 30, type: 'BLOCK' }, { x: 6800, y: 370, w: 30, h: 30, type: 'BLOCK' },
                { x: 7000, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_CUBE' }, { x: 7060, y: 370, w: 30, h: 30, type: 'SPIKE' },
                { x: 7500, y: 0, w: 30, h: 400, type: 'PORTAL_SPEED_NORMAL' }
            ];
        } else if (mapIndex === 1) {
            // MAP 2: FOCUS WAVE
            return [
                { x: 300, y: 0, w: 30, h: 400, type: 'PORTAL_SPEED_FAST' },
                { x: 330, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_WAVE' },
                { x: 600, y: 340, w: 30, h: 30, type: 'BLOCK' }, { x: 750, y: 310, w: 30, h: 30, type: 'BLOCK' },
                { x: 900, y: 250, w: 30, h: 30, type: 'BLOCK' }, { x: 1050, y: 310, w: 30, h: 30, type: 'BLOCK' },
                { x: 1200, y: 340, w: 30, h: 30, type: 'BLOCK' },
                { x: 1600, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_CUBE' },
                { x: 1700, y: 370, w: 30, h: 30, type: 'SPIKE' }
            ];
        } else if (mapIndex === 2) {
             // MAP 3: TỐC ĐỘ CAO
            return [
                { x: 300, y: 0, w: 30, h: 400, type: 'PORTAL_SPEED_FAST' },
                { x: 600, y: 370, w: 30, h: 30, type: 'SPIKE' }, { x: 660, y: 370, w: 30, h: 30, type: 'SPIKE' },
                { x: 720, y: 370, w: 30, h: 30, type: 'SPIKE' },
                { x: 1000, y: 370, w: 30, h: 30, type: 'BLOCK' }, { x: 1100, y: 340, w: 30, h: 30, type: 'BLOCK' },
                { x: 1200, y: 310, w: 30, h: 30, type: 'BLOCK' },
                { x: 1400, y: 0, w: 30, h: 400, type: 'PORTAL_MODE_WAVE' },
                { x: 1550, y: 340, w: 30, h: 30, type: 'BLOCK' }
            ];
        } else {
            // MAP 4 & 5 (Placeholder)
            return [{ x: 500, y: 370, w: 30, h: 30, type: 'BLOCK' }, { x: 700, y: 370, w: 30, h: 30, type: 'SPIKE' }];
        }
    }
    
    // Khởi tạo map
    let obstacles = getMapData(currentMapIndex);

    // --- INPUT HANDLING ---
    let isPressed = false;
    let isDrawing = false; 
    let isErasing = false; 
    
    // --- KHỞI TẠO ---
    setupEventListeners();

    function setupEventListeners() {
        // Chơi & Chế độ
        window.addEventListener('keydown', handleKeyDown);
        window.addEventListener('keyup', handleKeyUp);
        
        // Input Touch & Click (sử dụng chung isPressed)
        window.addEventListener('mousedown', (e) => { 
            if (currentMode === 'PLAY' || currentMode === 'GAMEOVER' || currentMode === 'VICTORY' || currentMode === 'MENU') isPressed = true;
        });
        window.addEventListener('mouseup', () => isPressed = false);
        window.addEventListener('touchstart', (e) => { 
            if (currentMode === 'PLAY' || currentMode === 'GAMEOVER' || currentMode === 'VICTORY' || currentMode === 'MENU') {
                 e.preventDefault(); 
                 isPressed = true;
            }
        });
        window.addEventListener('touchend', (e) => { 
            e.preventDefault(); 
            isPressed = false;
        });

        // Editor
        canvas.addEventListener('mousedown', handleEditorMouseDown);
        canvas.addEventListener('mousemove', handleEditorMouseMove);
        canvas.addEventListener('mouseup', handleEditorMouseUp);
        canvas.addEventListener('contextmenu', e => e.preventDefault()); 
        
        // UI Buttons
        document.getElementById('modeToggle').addEventListener('click', toggleMode);
        document.getElementById('saveMap').addEventListener('click', saveMap);
        document.getElementById('loadMap').addEventListener('click', loadMap);
        
        // Tool Buttons
        document.querySelectorAll('.tool-button').forEach(button => {
            button.addEventListener('click', (e) => {
                selectTool(e.target.dataset.type);
            });
        });
    }
    
    function handleKeyDown(e) {
        if (currentMode !== 'PLAY' && currentMode !== 'EDITOR' && currentMode !== 'GAMEOVER' && currentMode !== 'VICTORY') return; 
        
        if (e.code === 'Space' || e.code === 'ArrowUp') isPressed = true;
        if (e.code === 'KeyM') switchPlayerMode();
        if (e.code === 'KeyP') toggleMode(); 
        
        // R luôn reset vị trí và map hiện tại
        if (e.code === 'KeyR' && (currentMode === 'GAMEOVER' || currentMode === 'PLAY' || currentMode === 'VICTORY')) {
             resetGame(); 
             currentMode = 'PLAY';
        }
        
        // Chọn tool bằng số
        if (currentMode === 'EDITOR') {
            if (e.code === 'Digit1') selectTool('SPIKE');
            if (e.code === 'Digit2') selectTool('BLOCK');
            if (e.code === 'Digit3') selectTool('PAD');
            if (e.code === 'Digit4') selectTool('PORTAL_SPEED_NORMAL');
            if (e.code === 'Digit5') selectTool('PORTAL_SPEED_FAST');
            if (e.code === 'Digit6') selectTool('PORTAL_MODE_WAVE');
            if (e.code === 'Digit7') selectTool('PORTAL_MODE_CUBE');
            if (e.code === 'KeyE') isErasing = true;
        }
    }
    
    function handleKeyUp(e) {
        if (e.code === 'Space' || e.code === 'ArrowUp') isPressed = false;
        if (currentMode === 'EDITOR' && e.code === 'KeyE') isErasing = false;
    }

    function selectTool(type) {
        selectedTool = type;
        document.querySelectorAll('.tool-button').forEach(btn => {
            btn.classList.remove('active');
            if(btn.dataset.type === type) btn.classList.add('active');
        });
    }

    function switchPlayerMode() {
        playerMode = playerMode === 'CUBE' ? 'WAVE' : 'CUBE';
        player.trail = []; 
        player.dy = 0;
    }

    function toggleMode() {
        currentMode = currentMode === 'PLAY' ? 'EDITOR' : 'PLAY';
        document.getElementById('modeToggle').innerText = `Chế độ: ${currentMode} (P)`;
        
        if (currentMode === 'PLAY') {
            document.getElementById('editorControls').style.display = 'none';
            resetPlayer();
        } else {
             document.getElementById('editorControls').style.display = 'flex';
            player.x = 150;
            player.y = 300;
        }
    }
    
    // --- CHUYỂN MÀN HÌNH ---
    function showScreen(screenId) {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('levelSelect').style.display = 'none';
        document.getElementById('skinSelect').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'none';
        document.getElementById('editorControls').style.display = 'none';
        
        const screenElement = document.getElementById(screenId);
        if (screenElement) {
            screenElement.style.display = 'flex';
        }
        
        currentMode = screenId === 'gameContainer' ? 'PLAY' : (screenId === 'editorScreen' ? 'EDITOR' : 'MENU');
        
        if (currentMode === 'EDITOR') {
             document.getElementById('gameContainer').style.display = 'block';
             document.getElementById('editorControls').style.display = 'flex';
        } else if (currentMode === 'PLAY') {
             document.getElementById('gameContainer').style.display = 'block';
             resetPlayer();
        } else if (screenId === 'skinSelect') {
             renderSkinMenu();
        }
    }
    
    function startGame(mapIndex) {
        currentMapIndex = mapIndex; 
        obstacles = getMapData(mapIndex);
        showScreen('gameContainer');
        resetPlayer();
    }
    
    // --- SKINS LOGIC ---
    function setSkin(skin) {
        currentSkin = skin;
        player.color = skin.color;
        renderSkinMenu(); 
    }

    function renderSkinMenu() {
        const menu = document.getElementById('skinMenu');
        menu.innerHTML = '';
        
        SKINS.forEach(skin => {
            const button = document.createElement('div');
            button.className = `skin-option ${skin.class}`;
            button.innerText = skin.name;
            button.onclick = () => setSkin(skin);
            
            if (skin.color === currentSkin.color) {
                button.classList.add('active');
            }
            menu.appendChild(button);
        });
    }
    
    // --- EDITOR LOGIC (Không đổi) ---
    function getGridPosition(event) {
        const rect = canvas.getBoundingClientRect();
        const clientX = event.touches ? event.touches[0].clientX : event.clientX;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        
        const mouseX = clientX - rect.left;
        const mouseY = clientY - rect.top;
        
        const gridX = Math.floor(mouseX / GRID_SIZE) * GRID_SIZE;
        const gridY = Math.floor(mouseY / GRID_SIZE) * GRID_SIZE;
        
        return { x: gridX, y: gridY };
    }

    function handleEditorMouseDown(e) {
        if (currentMode !== 'EDITOR') return;
        
        if (e.button === 2 || isErasing) { 
            placeOrEraseObstacle(e, true);
        } else {
            isDrawing = true;
            placeOrEraseObstacle(e, false);
        }
    }

    function handleEditorMouseMove(e) {
        if (currentMode !== 'EDITOR') return;
        if (isDrawing || isErasing) {
            placeOrEraseObstacle(e, isErasing);
        }
    }

    function handleEditorMouseUp(e) {
        isDrawing = false;
    }

    function placeOrEraseObstacle(e, erase) {
        const pos = getGridPosition(e);
        
        if (pos.y >= floorY - GRID_SIZE && !selectedTool.startsWith('PORTAL') && !erase) return; 

        let existingIndex = obstacles.findIndex(obs => {
            if (obs.x === pos.x) {
                if (obs.type.startsWith('PORTAL')) return true; 
                if (obs.y === pos.y) return true;
            }
            return false;
        });

        if (erase) {
            if (existingIndex !== -1) {
                obstacles.splice(existingIndex, 1);
            }
        } else {
            if (existingIndex !== -1) {
                obstacles.splice(existingIndex, 1);
            }
            
            if (selectedTool.startsWith('PORTAL')) {
                 obstacles.push({
                    x: pos.x, y: 0, w: GRID_SIZE, h: floorY, type: selectedTool
                });
            } else {
                 obstacles.push({
                    x: pos.x, y: pos.y, w: GRID_SIZE, h: GRID_SIZE, type: selectedTool
                });
            }
        }
    }
    
    function saveMap() {
        try {
            const mapData = JSON.stringify(obstacles);
            localStorage.setItem('gd_map_data', mapData);
            alert('Map đã được lưu vào trình duyệt của bạn!');
        } catch (e) {
            alert('Lỗi khi lưu map: ' + e.message);
        }
    }

    function loadMap() {
        try {
            const mapData = localStorage.getItem('gd_map_data');
            if (mapData) {
                obstacles = JSON.parse(mapData);
                alert('Map đã được tải thành công!');
                toggleMode();
            } else {
                alert('Không tìm thấy map nào được lưu.');
            }
        } catch (e) {
            alert('Lỗi khi tải map: ' + e.message);
        }
    }

    // --- LOGIC CHƠI (Đã cập nhật Victory) ---
    function resetPlayer() {
        player.x = 150;
        player.y = 300;
        player.dy = 0;
        player.angle = 0;
        player.trail = [];
        player.cubeParticles = [];
        player.lastPortalPassed = null;
        GAME_SPEED = SPEED_NORMAL;
        playerMode = 'CUBE';
        frame = 0;
        score = 0;
    }

    function resetGame() {
        // Bấm R hoặc chạm/click vào màn hình Game Over/Victory sẽ tải lại map hiện tại
        obstacles = getMapData(currentMapIndex); 
        resetPlayer();
        currentMode = 'PLAY';
    }
    
    function gameOver() {
        currentMode = 'GAMEOVER';
    }
    
    function updatePlayMode() {
        score++;
        frame++;

        // KIỂM TRA CHIẾN THẮNG
        if (score >= VICTORY_SCORE) {
            currentMode = 'VICTORY';
            return; 
        }

        // Xử lý Player
        if (playerMode === 'CUBE') {
            player.dy += GRAVITY;
            player.y += player.dy;

            if (player.y + player.h >= floorY) { 
                player.y = floorY - player.h;
                player.dy = 0;
                let nearestRightAngle = Math.round(player.angle / 90) * 90;
                player.angle += (nearestRightAngle - player.angle) * 0.2;

                if (isPressed) { player.dy = JUMP_FORCE; }
            } else {
                player.angle += 4;
                if (frame % 3 === 0) {
                    player.cubeParticles.push({x: player.x, y: player.y, angle: player.angle, life: 1.0});
                }
            }
        } else if (playerMode === 'WAVE') {
            if (isPressed) { player.dy = -WAVE_SPEED_Y; } else { player.dy = WAVE_SPEED_Y; }
            player.y += player.dy;
            player.angle = player.dy > 0 ? 45 : -45;

            player.trail.push({x: player.x, y: player.y + player.h/2});
            
            if (player.y + player.h > floorY || player.y < 0) {
                gameOver();
            }
        }
        
        // Cập nhật hiệu ứng
        for (let i = player.cubeParticles.length - 1; i >= 0; i--) {
            let p = player.cubeParticles[i];
            p.x -= GAME_SPEED;
            p.life -= 0.05;
            if (p.life <= 0) player.cubeParticles.splice(i, 1);
        }
        for (let i = 0; i < player.trail.length; i++) {
            player.trail[i].x -= GAME_SPEED;
        }
        if (player.trail.length > 40) player.trail.shift();

        // Xử lý Map và Va chạm
        for (let i = obstacles.length - 1; i >= 0; i--) {
            let obs = obstacles[i];
            
            obs.x -= GAME_SPEED;

            // XỬ LÝ PORTAL
            if (obs.type.startsWith('PORTAL')) {
                if (obs.x + obs.w < player.x && obs.x + obs.w > player.lastPortalPassed) {
                    player.lastPortalPassed = obs.x + obs.w;
                    
                    if (obs.type === 'PORTAL_SPEED_FAST') { GAME_SPEED = SPEED_FAST; } 
                    else if (obs.type === 'PORTAL_SPEED_NORMAL') { GAME_SPEED = SPEED_NORMAL; }
                    else if (obs.type === 'PORTAL_MODE_WAVE') { playerMode = 'WAVE'; player.dy = 0; }
                    else if (obs.type === 'PORTAL_MODE_CUBE') { playerMode = 'CUBE'; player.dy = 0; }
                }
            } 
            
            // XỬ LÝ VA CHẠM VỚI VẬT THỂ
            else { 
                if (
                    player.x < obs.x + obs.w && player.x + player.w > obs.x &&
                    player.y < obs.y + obs.h && player.y + player.h > obs.y
                ) {
                    if (obs.type === 'PAD' && player.dy >= 0 && player.y + player.h <= obs.y + 10) {
                        player.dy = JUMP_FORCE * 1.5;
                    } else {
                        gameOver();
                    }
                }
            }
        }
        
        obstacles = obstacles.filter(obs => obs.x + obs.w > 0);
    }
    
    // --- VẼ ĐỒ HỌA (Đã cập nhật Victory) ---
    function draw() {
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Nền Grid
        ctx.strokeStyle = '#222';
        ctx.lineWidth = 1;
        let bgOffset = (frame * GAME_SPEED * (currentMode === 'PLAY' ? 0.5 : 0)) % GRID_SIZE;
        for (let x = -bgOffset; x < GAME_WIDTH; x += GRID_SIZE) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, GAME_HEIGHT); ctx.stroke();
        }
        
        // VẼ GRID cho Editor
        if (currentMode === 'EDITOR') {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            for (let y = 0; y < floorY; y += GRID_SIZE) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(GAME_WIDTH, y); ctx.stroke();
            }
        }

        // Sàn
        ctx.fillStyle = '#000';
        ctx.fillRect(0, floorY, GAME_WIDTH, floorHeight);
        ctx.strokeStyle = currentSkin.color; 
        ctx.lineWidth = 2;
        ctx.shadowBlur = 10;
        ctx.shadowColor = currentSkin.color;
        ctx.beginPath(); ctx.moveTo(0, floorY); ctx.lineTo(GAME_WIDTH, floorY); ctx.stroke();
        ctx.shadowBlur = 0; 

        // VẼ PLAYER & HIỆU ỨNG
        if (currentMode === 'PLAY' || currentMode === 'EDITOR') {
            drawPlayer(playerMode);
        }

        // VẼ CHƯỚNG NGẠI VẬT VÀ PORTAL
        for (let obs of obstacles) {
            drawObstacle(obs);
        }

        // UI Score
        document.getElementById('score').innerText = (currentMode === 'PLAY' || currentMode === 'GAMEOVER' || currentMode === 'VICTORY') 
            ? `Score: ${Math.floor(score/10)} | Speed: ${GAME_SPEED}` 
            : `Đang chỉnh sửa map | Tool: ${selectedTool}`;
        
        // Màn hình Game Over
        if (currentMode === 'GAMEOVER') {
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            ctx.fillStyle = 'white';
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText("GAME OVER", GAME_WIDTH/2, GAME_HEIGHT/2);
            ctx.font = '20px Arial';
            ctx.fillText("Nhấn R hoặc Chạm/Click để chơi lại", GAME_WIDTH/2, GAME_HEIGHT/2 + 40);
        }
        
        // Màn hình Victory (Mới)
        if (currentMode === 'VICTORY') {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'gold';
            ctx.textAlign = 'center';
            ctx.font = '72px Arial';
            ctx.fillText('CHIẾN THẮNG!', canvas.width / 2, canvas.height / 2 - 50);
            ctx.fillStyle = 'white';
            ctx.font = '24px Arial';
            ctx.fillText(`Điểm của bạn: ${Math.floor(score/10)}`, canvas.width / 2, canvas.height / 2 + 20);
            ctx.font = '20px Arial';
            ctx.fillText('Nhấn R hoặc Chạm/Click để chơi lại', canvas.width / 2, canvas.height / 2 + 80);
        }
    }
    
    function drawObstacle(obs) {
        ctx.shadowBlur = 10;
        
        if (obs.type === 'SPIKE') {
            ctx.fillStyle = '#ff0000'; ctx.shadowColor = '#ff0000';
            ctx.beginPath(); ctx.moveTo(obs.x, obs.y + obs.h);
            ctx.lineTo(obs.x + obs.w/2, obs.y); ctx.lineTo(obs.x + obs.w, obs.y + obs.h); ctx.fill();
        } else if (obs.type === 'BLOCK') {
            ctx.fillStyle = '#8a2be2'; ctx.shadowColor = '#8a2be2';
            ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
        } else if (obs.type === 'PAD') {
             ctx.fillStyle = '#ffff00'; ctx.shadowColor = '#ffff00';
             ctx.beginPath(); ctx.arc(obs.x + obs.w/2, obs.y + obs.h, obs.w/2, Math.PI, 0, false); ctx.fill();
        } else if (obs.type.startsWith('PORTAL')) {
            const isSpeed = obs.type.includes('SPEED');
            let color = '';
            if (obs.type === 'PORTAL_SPEED_FAST') { color = '#00ff00'; } else if (obs.type === 'PORTAL_SPEED_NORMAL') { color = '#ffff00'; }
            else if (obs.type === 'PORTAL_MODE_WAVE') { color = '#ff00ff'; } else if (obs.type === 'PORTAL_MODE_CUBE') { color = '#00ffff'; }
            
            ctx.fillStyle = `${color}30`;
            ctx.shadowColor = color;
            ctx.shadowBlur = 20;
            ctx.fillRect(obs.x, 0, obs.w, floorY);
            ctx.shadowBlur = 0;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            const arrowY = floorY / 2;
            if (isSpeed) {
                if (obs.type === 'PORTAL_SPEED_FAST') {
                    ctx.moveTo(obs.x + 5, arrowY); ctx.lineTo(obs.x + obs.w / 2, arrowY - 10); ctx.lineTo(obs.x + obs.w - 5, arrowY);
                    ctx.moveTo(obs.x + obs.w / 2, arrowY); ctx.lineTo(obs.x + obs.w / 2 + 10, arrowY - 10);
                } else {
                    ctx.moveTo(obs.x + 5, arrowY); ctx.lineTo(obs.x + obs.w - 5, arrowY);
                }
            } else { 
                const iconX = obs.x + obs.w / 2;
                const iconY = floorY / 2;
                if (obs.type === 'PORTAL_MODE_WAVE') {
                    ctx.moveTo(iconX - 10, iconY - 10); ctx.lineTo(iconX - 10, iconY + 10); ctx.lineTo(iconX + 10, iconY); ctx.closePath(); ctx.stroke();
                } else {
                    ctx.strokeRect(iconX - 10, iconY - 10, 20, 20);
                }
            }
            ctx.stroke();
        }

        ctx.shadowBlur = 0;
    }
    
    function drawPlayer(mode) {
        // VẼ ĐUÔI WAVE/CUBE
        if (mode === 'WAVE' && player.trail.length > 1) {
            ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.shadowBlur = 15;
            ctx.shadowColor = currentSkin.color; ctx.lineWidth = 8; ctx.strokeStyle = currentSkin.color;
            ctx.globalAlpha = 0.6; ctx.beginPath(); ctx.moveTo(player.trail[0].x, player.trail[0].y);
            for (let i = 1; i < player.trail.length; i++) { ctx.lineTo(player.trail[i].x, player.trail[i].y); } ctx.stroke();
            ctx.shadowBlur = 0; ctx.globalAlpha = 1; ctx.lineWidth = 3; ctx.strokeStyle = '#fff';
            ctx.beginPath(); ctx.moveTo(player.trail[0].x, player.trail[0].y);
            for (let i = 1; i < player.trail.length; i++) { ctx.lineTo(player.trail[i].x, player.trail[i].y); } ctx.stroke();
        } else if (mode === 'CUBE') {
            for (let p of player.cubeParticles) {
                ctx.save(); ctx.translate(p.x + player.w/2, p.y + player.h/2); ctx.rotate(p.angle * Math.PI / 180);
                ctx.fillStyle = currentSkin.color; ctx.globalAlpha = p.life * 0.5;
                ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h); ctx.restore();
            }
            ctx.globalAlpha = 1;
        }

        // VẼ CHÍNH THỂ PLAYER
        ctx.save(); ctx.translate(player.x + player.w/2, player.y + player.h/2);
        ctx.rotate(player.angle * Math.PI / 180); ctx.shadowBlur = 20;
        ctx.shadowColor = currentSkin.color; ctx.fillStyle = currentSkin.color;

        if (mode === 'CUBE') {
            ctx.fillRect(-player.w/2, -player.h/2, player.w, player.h);
            ctx.fillStyle = '#000'; ctx.fillRect(0, -5, 10, 10);
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.strokeRect(-player.w/2, -player.h/2, player.w, player.h);
        } else if (mode === 'WAVE') {
            ctx.beginPath(); ctx.moveTo(-player.w/2, -player.h/2); ctx.lineTo(-player.w/2, player.h/2);
            ctx.lineTo(player.w/2, 0); ctx.fill();
        }
        ctx.restore(); ctx.shadowBlur = 0; 
    }

    // --- GAME LOOP ---
    function loop() {
        if (currentMode === 'PLAY') {
            updatePlayMode();
        } 
        
        // Logic xử lý khi game kết thúc (Mobile/Click Reset)
        if ((currentMode === 'GAMEOVER' || currentMode === 'VICTORY' || currentMode === 'MENU') && isPressed) {
            if (currentMode === 'MENU') {
                // Khi ở Menu, click/tap chỉ đặt cờ chơi lại, không tự động reset game
                // Hàm showScreen('gameContainer') sẽ gọi resetPlayer()
            } else {
                // Game Over/Victory: Bấm hoặc chạm để chơi lại
                resetGame();
                currentMode = 'PLAY'; 
                isPressed = false; 
            }
        }
        
        draw();
        requestAnimationFrame(loop);
    }
    
    // Khởi tạo
    showScreen('mainMenu');
    loop();

</script>
</body>
</html>